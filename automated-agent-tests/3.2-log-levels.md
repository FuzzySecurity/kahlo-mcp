# Phase 3.2 - Logging Levels Test

**Job ID**: `job_f9e30a27-d040-4e97-9524-832ba88db101`
**Target ID**: `tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6`
**Status**: COMPLETE
**Timestamp**: 2026-01-21T06:08:13.250Z

## Test Objective

Validate that the Kahlo instrumentation framework correctly handles all logging levels (debug, info, warn, error) for both:
1. `ctx.log()` - convenience wrapper
2. `ctx.emit()` - direct event emission

## Test Execution

### Job Source Code
```javascript
module.exports = {
  start: function(params, ctx) {
    // Test ctx.log at all levels
    ctx.log('debug', 'Debug message', {extra: 'debug_data'});
    ctx.log('info', 'Info message', {extra: 'info_data'});
    ctx.log('warn', 'Warning message', {extra: 'warn_data'});
    ctx.log('error', 'Error message', {extra: 'error_data'});

    // Test ctx.emit with all levels
    ctx.emit('test.debug', {level: 'debug'}, 'debug');
    ctx.emit('test.info', {level: 'info'}, 'info');
    ctx.emit('test.warn', {level: 'warn'}, 'warn');
    ctx.emit('test.error', {level: 'error'}, 'error');

    return {logged: true};
  }
};
```

### Job Status
- **State**: completed
- **Type**: oneshot
- **Health**: unknown (expected for oneshot)
- **Created**: 2026-01-21T06:08:13.250Z
- **Updated**: 2026-01-21T06:08:13.453Z
- **Duration**: ~203ms

## Events Captured

### Event 1: Job Started (Infrastructure)
```json
{
  "event_id": "f27d26c2-6cfb-4631-bd8b-64f6ffafe600",
  "ts": "2026-01-21T06:08:14.768Z",
  "target_id": "tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6",
  "pid": 13791,
  "job_id": "job_f9e30a27-d040-4e97-9524-832ba88db101",
  "kind": "job.started",
  "level": "info",
  "payload": {
    "job_id": "job_f9e30a27-d040-4e97-9524-832ba88db101",
    "type": "oneshot"
  }
}
```

### Event 2: ctx.log('debug', ...)
```json
{
  "event_id": "12a34645-e887-4d39-ab85-5f3dd6152279",
  "ts": "2026-01-21T06:08:14.769Z",
  "target_id": "tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6",
  "pid": 13791,
  "job_id": "job_f9e30a27-d040-4e97-9524-832ba88db101",
  "kind": "log",
  "level": "debug",
  "payload": {
    "message": "Debug message",
    "extra": {
      "extra": "debug_data"
    }
  }
}
```

### Event 3: ctx.log('info', ...)
```json
{
  "event_id": "9ca7511b-6a2d-4fff-be3d-b26198d25e52",
  "ts": "2026-01-21T06:08:14.769Z",
  "target_id": "tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6",
  "pid": 13791,
  "job_id": "job_f9e30a27-d040-4e97-9524-832ba88db101",
  "kind": "log",
  "level": "info",
  "payload": {
    "message": "Info message",
    "extra": {
      "extra": "info_data"
    }
  }
}
```

### Event 4: ctx.log('warn', ...)
```json
{
  "event_id": "34fc5ef2-500a-4cf4-9b88-20d471da8d02",
  "ts": "2026-01-21T06:08:14.769Z",
  "target_id": "tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6",
  "pid": 13791,
  "job_id": "job_f9e30a27-d040-4e97-9524-832ba88db101",
  "kind": "log",
  "level": "warn",
  "payload": {
    "message": "Warning message",
    "extra": {
      "extra": "warn_data"
    }
  }
}
```

### Event 5: ctx.log('error', ...)
```json
{
  "event_id": "43e5477a-1d7b-4b4e-bf80-cf7aa70dd587",
  "ts": "2026-01-21T06:08:14.769Z",
  "target_id": "tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6",
  "pid": 13791,
  "job_id": "job_f9e30a27-d040-4e97-9524-832ba88db101",
  "kind": "log",
  "level": "error",
  "payload": {
    "message": "Error message",
    "extra": {
      "extra": "error_data"
    }
  }
}
```

### Event 6: ctx.emit('test.debug', ..., 'debug')
```json
{
  "event_id": "e7a98c06-42c0-4479-8fd9-2eafc037cada",
  "ts": "2026-01-21T06:08:14.769Z",
  "target_id": "tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6",
  "pid": 13791,
  "job_id": "job_f9e30a27-d040-4e97-9524-832ba88db101",
  "kind": "test.debug",
  "level": "debug",
  "payload": {
    "level": "debug"
  }
}
```

### Event 7: ctx.emit('test.info', ..., 'info')
```json
{
  "event_id": "e5729305-c890-48da-9205-6c95c4343429",
  "ts": "2026-01-21T06:08:14.770Z",
  "target_id": "tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6",
  "pid": 13791,
  "job_id": "job_f9e30a27-d040-4e97-9524-832ba88db101",
  "kind": "test.info",
  "level": "info",
  "payload": {
    "level": "info"
  }
}
```

### Event 8: ctx.emit('test.warn', ..., 'warn')
```json
{
  "event_id": "192dc64e-0060-4a39-a458-aef0c80568ba",
  "ts": "2026-01-21T06:08:14.770Z",
  "target_id": "tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6",
  "pid": 13791,
  "job_id": "job_f9e30a27-d040-4e97-9524-832ba88db101",
  "kind": "test.warn",
  "level": "warn",
  "payload": {
    "level": "warn"
  }
}
```

### Event 9: ctx.emit('test.error', ..., 'error')
```json
{
  "event_id": "8ac81ecf-f54c-44a1-961b-51f92440814d",
  "ts": "2026-01-21T06:08:14.770Z",
  "target_id": "tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6",
  "pid": 13791,
  "job_id": "job_f9e30a27-d040-4e97-9524-832ba88db101",
  "kind": "test.error",
  "level": "error",
  "payload": {
    "level": "error"
  }
}
```

### Event 10: Job Completed (Infrastructure)
```json
{
  "event_id": "11a78e67-8f75-49e7-a06c-446c7036b952",
  "ts": "2026-01-21T06:08:14.770Z",
  "target_id": "tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6",
  "pid": 13791,
  "job_id": "job_f9e30a27-d040-4e97-9524-832ba88db101",
  "kind": "job.completed",
  "level": "info",
  "payload": {
    "result": {
      "logged": true
    }
  }
}
```

## Validation Results

### ✅ All log levels emit correctly (debug, info, warn, error)
**PASS** - All four log levels were successfully emitted and captured:
- `debug`: Events 2 and 6
- `info`: Events 3 and 7
- `warn`: Events 4 and 8
- `error`: Events 5 and 9

### ✅ ctx.log wraps ctx.emit properly (events have kind='log')
**PASS** - All `ctx.log()` calls generated events with `kind="log"`:
- Event 2: `ctx.log('debug', ...)` → `kind="log"`, `level="debug"`
- Event 3: `ctx.log('info', ...)` → `kind="log"`, `level="info"`
- Event 4: `ctx.log('warn', ...)` → `kind="log"`, `level="warn"`
- Event 5: `ctx.log('error', ...)` → `kind="log"`, `level="error"`

### ✅ Events retrievable with correct levels
**PASS** - All events were successfully retrieved via `kahlo_events_fetch()` with correct level assignment:
- Debug level: 1 event (Event 2, Event 6)
- Info level: 3 events (Event 1, Event 3, Event 7, Event 10)
- Warn level: 2 events (Event 4, Event 8)
- Error level: 2 events (Event 5, Event 9)

### ✅ Extra data preserved in payload
**PASS** - All extra data passed to `ctx.log()` was correctly preserved in event payloads:
- Event 2: `payload.extra = {extra: "debug_data"}` ✓
- Event 3: `payload.extra = {extra: "info_data"}` ✓
- Event 4: `payload.extra = {extra: "warn_data"}` ✓
- Event 5: `payload.extra = {extra: "error_data"}` ✓

All `ctx.emit()` calls also preserved their payloads correctly:
- Event 6-9: `payload.level` correctly reflects the level parameter ✓

## Observations

### Event Timing
All events (2-9) emitted within a 1-millisecond window (14.769-14.770Z), demonstrating synchronous execution within the `start()` function.

### Event Ordering
Events are correctly ordered in execution sequence:
1. Infrastructure: job.started
2. User code: 4x ctx.log() calls
3. User code: 4x ctx.emit() calls
4. Infrastructure: job.completed

### Payload Structure
- `ctx.log()` creates structured payloads with `message` + `extra` fields
- `ctx.emit()` accepts arbitrary payload objects
- Both preserve data fidelity through serialization

### Process Context
All events correctly associated with:
- Target: `tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6`
- PID: 13791
- Job: `job_f9e30a27-d040-4e97-9524-832ba88db101`

## Conclusion

**STATUS**: COMPLETE

All validation criteria passed. The Kahlo logging infrastructure correctly:
1. Supports all four standard log levels (debug, info, warn, error)
2. Implements `ctx.log()` as a proper wrapper over `ctx.emit()` with `kind='log'`
3. Preserves event level metadata through the entire pipeline
4. Maintains payload data integrity for both structured and arbitrary data
5. Provides reliable event retrieval via the events API

The test confirms that instrumentation jobs have full, type-safe control over event severity levels and can emit both structured logs and custom telemetry events with appropriate severity classification.
