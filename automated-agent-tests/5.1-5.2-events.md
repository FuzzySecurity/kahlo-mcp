# Phase 5 - Event System Testing (Extended)

**Target**: `tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6`
**Test Date**: 2026-01-21T06:16:07Z
**Job ID**: `job_5c453fc5-74be-4d3c-952f-b4b231e5726a`

---

## Test 5.1 - Event Pagination

### Objective
Validate that the event system can handle high-volume event emission and support cursor-based pagination correctly.

### Test Setup
Emitted 53 events total:
- 50 `test.event` events (indices 0-49) with alternating levels (info/debug)
- 1 `crypto.key` event (warn level)
- 1 `network.request` event (info level)
- 1 `error.occurred` event (error level)

### Job Status
```json
{
  "job_id": "job_5c453fc5-74be-4d3c-952f-b4b231e5726a",
  "target_id": "tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6",
  "type": "oneshot",
  "state": "completed",
  "health": "unknown",
  "created_at": "2026-01-21T06:16:07.639Z",
  "updated_at": "2026-01-21T06:16:07.830Z"
}
```

---

## Pagination Test Results

### Page 1 - First 20 Events
**Request**: `kahlo_events_fetch(job_id, limit=20)`

**Cursor Returned**: `v1:j:job_5c453fc5-74be-4d3c-952f-b4b231e5726a:20`

**Events Retrieved**: 20 events (indices 0-18 of test.event)

**Sample Events**:
```json
{
  "event_id": "7c00da82-cae7-4bb5-b7a5-3e38db0576ea",
  "ts": "2026-01-21T06:16:09.142Z",
  "target_id": "tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6",
  "pid": 13791,
  "job_id": "job_5c453fc5-74be-4d3c-952f-b4b231e5726a",
  "kind": "job.started",
  "level": "info",
  "payload": {
    "job_id": "job_5c453fc5-74be-4d3c-952f-b4b231e5726a",
    "type": "oneshot"
  }
}
```

```json
{
  "event_id": "0f350b00-6983-470a-b065-c3fb38f1b74b",
  "ts": "2026-01-21T06:16:09.142Z",
  "kind": "test.event",
  "level": "info",
  "payload": {
    "index": 0,
    "timestamp": 1769753769142,
    "data": "payload_0"
  }
}
```

```json
{
  "event_id": "06bfd2e0-9c12-4ba0-aeaf-e1d418434784",
  "ts": "2026-01-21T06:16:09.142Z",
  "kind": "test.event",
  "level": "debug",
  "payload": {
    "index": 1,
    "timestamp": 1769753769142,
    "data": "payload_1"
  }
}
```

---

### Page 2 - Events 20-39
**Request**: `kahlo_events_fetch(job_id, cursor="v1:j:job_5c453fc5-74be-4d3c-952f-b4b231e5726a:20", limit=20)`

**Cursor Returned**: `v1:j:job_5c453fc5-74be-4d3c-952f-b4b231e5726a:40`

**Events Retrieved**: 20 events (indices 19-38 of test.event)

**Sample Events**:
```json
{
  "event_id": "1e938653-aa75-4d35-848d-480fde31634c",
  "ts": "2026-01-21T06:16:09.143Z",
  "kind": "test.event",
  "level": "debug",
  "payload": {
    "index": 19,
    "timestamp": 1769753769143,
    "data": "payload_19"
  }
}
```

```json
{
  "event_id": "1aa620a1-a54d-403b-81fe-fb32680c281e",
  "ts": "2026-01-21T06:16:09.144Z",
  "kind": "test.event",
  "level": "info",
  "payload": {
    "index": 38,
    "timestamp": 1769753769144,
    "data": "payload_38"
  }
}
```

---

### Page 3 - Final Events
**Request**: `kahlo_events_fetch(job_id, cursor="v1:j:job_5c453fc5-74be-4d3c-952f-b4b231e5726a:40", limit=20)`

**Cursor Returned**: `v1:j:job_5c453fc5-74be-4d3c-952f-b4b231e5726a:55`

**Events Retrieved**: 15 events (final page)

**Key Events**:
```json
{
  "event_id": "2de82fd8-3052-4dc3-b505-9083fc9d5e52",
  "ts": "2026-01-21T06:16:09.144Z",
  "kind": "test.event",
  "level": "info",
  "payload": {
    "index": 48,
    "timestamp": 1769753769144,
    "data": "payload_48"
  }
}
```

```json
{
  "event_id": "767b7a89-d998-48de-ac3d-36efe12144f6",
  "ts": "2026-01-21T06:16:09.145Z",
  "kind": "test.event",
  "level": "debug",
  "payload": {
    "index": 49,
    "timestamp": 1769753769145,
    "data": "payload_49"
  }
}
```

```json
{
  "event_id": "8e2ce413-48d8-46b3-a962-01cfa03bb3bd",
  "ts": "2026-01-21T06:16:09.145Z",
  "kind": "crypto.key",
  "level": "warn",
  "payload": {
    "key": "test_key_data"
  }
}
```

```json
{
  "event_id": "56d1cca1-cf6a-467a-847b-d2d8ab7cf410",
  "ts": "2026-01-21T06:16:09.145Z",
  "kind": "network.request",
  "level": "info",
  "payload": {
    "url": "https://example.com"
  }
}
```

```json
{
  "event_id": "9dedece3-7dee-49fb-81b4-1689a03833da",
  "ts": "2026-01-21T06:16:09.145Z",
  "kind": "error.occurred",
  "level": "error",
  "payload": {
    "message": "test error"
  }
}
```

```json
{
  "event_id": "f23bc091-205a-4ab0-b63c-d39543d62ea7",
  "ts": "2026-01-21T06:16:09.145Z",
  "kind": "job.completed",
  "level": "info",
  "payload": {
    "result": {
      "events_emitted": 53
    }
  }
}
```

---

## Target-Wide Event Fetch

**Request**: `kahlo_events_fetch(target_id="tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6", limit=100)`

**Events Retrieved**: 100 events from multiple jobs across the target's lifetime

**Jobs Represented**:
- `job_9c990456-b430-48ce-b0de-c3101b4da1de` - Bootstrap job
- `job_f9e30a27-d040-4e97-9524-832ba88db101` - Logging test job
- `job_cc0b821d-d257-42a0-81ba-2bb6c1991e73` - Daemon job with heartbeats
- `job_58f8635f-247e-4a74-a427-002ae1cc15b5` - Context API test job
- `job_c2036ebc-e68b-4381-89ab-336040f9437a` - Long-running daemon
- `job_5c453fc5-74be-4d3c-952f-b4b231e5726a` - Current pagination test job (not in first 100 events)

**Cursor Returned**: `v1:t:tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6:100`

**Event Timeline**:
- Earliest event: `2026-01-21T06:06:10.551Z`
- Latest event in fetch: `2026-01-21T06:12:28.475Z`

**Event Kind Diversity**:
- `job.started`, `job.completed`
- `bootstrap.started`, `bootstrap.complete`
- `app.onCreate`
- `log` (debug/info/warn/error levels)
- `test.debug`, `test.info`, `test.warn`, `test.error`
- `daemon.started`
- `sleep.complete`
- `tick` (daemon heartbeat ticks)
- `timeout.fired`
- `interval.complete`
- `init.called`
- `ctx.job_id`, `ctx.javaAvailable`, `ctx.requireJava`
- `params.received`
- `hooks.installed`
- `heartbeat.tick`

---

## Validation Results

### Pagination Validation
- [x] **All emitted events retrievable**: All 53 events (50 test.event + 3 special kinds) successfully retrieved across 3 pages
- [x] **Cursor pagination works correctly**: Cursors provided in each response, allowing seamless navigation through event stream
- [x] **Events ordered by timestamp**: All events appear in chronological order (timestamp field `ts` consistently increases)
- [x] **Different event kinds captured**: Successfully captured all 4 event kinds:
  - `test.event` (50 events, alternating info/debug)
  - `crypto.key` (1 event, warn level)
  - `network.request` (1 event, info level)
  - `error.occurred` (1 event, error level)

### Additional Observations

**Cursor Format**:
- Job-scoped cursors: `v1:j:job_5c453fc5-74be-4d3c-952f-b4b231e5726a:<offset>`
- Target-scoped cursors: `v1:t:tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6:<offset>`

**Event ID Uniqueness**: Every event has a unique UUID event_id

**Event Completeness**: Each event contains:
- `event_id` (UUID)
- `ts` (ISO 8601 timestamp)
- `target_id`
- `pid` (process ID)
- `job_id`
- `kind` (custom event type)
- `level` (debug/info/warn/error)
- `payload` (arbitrary JSON)

**Performance**: High-volume event emission (53 events in rapid succession) completed in ~3ms (job duration: 191ms total including orchestrator overhead)

**Event Persistence**: Events persisted across multiple job executions, target-wide fetch retrieved events from jobs spanning ~10 minutes of runtime

---

## Test Status

**Status**: COMPLETE

**Confidence**: High - All validation criteria met

**Key Findings**:
1. Pagination mechanism is robust and handles cursor-based navigation correctly
2. Event ordering is strictly chronological
3. System handles diverse event kinds and levels
4. Events are properly scoped to both job_id and target_id
5. No event loss observed during high-volume emission
6. Cursor format is versioned (v1) and semantically meaningful

**Recommendations**:
- Event system is production-ready for instrumentation telemetry
- Cursor-based pagination is efficient for long-running targets with thousands of events
- Target-wide event fetching enables cross-job correlation and analysis
