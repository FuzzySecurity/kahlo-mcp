# Phase 2.3 - Spawn Mode with Bootstrap (gating=spawn)

**Objective**: Test spawn mode with bootstrap to capture early application initialization hooks

**Date**: 2026-01-21T06:06:10Z

---

## Setup

### 1. Detach Previous Target
**Target ID**: `tgt_01f45118-44f3-46dc-9531-e6856aad2947`

**Detach Result**:
```json
{
  "ok": true,
  "data": {
    "target_id": "tgt_01f45118-44f3-46dc-9531-e6856aad2947",
    "state": "detached"
  }
}
```

### 2. Force Stop LINE Application
**Command**: `adb shell am force-stop jp.naver.line.android`

**Result**:
```json
{
  "ok": true,
  "data": {
    "stdout": "",
    "command": "shell am force-stop jp.naver.line.android",
    "device_id": "2C161FDH200CY0"
  }
}
```

---

## Spawn with Bootstrap

### Configuration
- **Device ID**: `2C161FDH200CY0`
- **Package**: `jp.naver.line.android`
- **Mode**: `spawn`
- **Gating**: `spawn` (app suspended until bootstrap completes)
- **Bootstrap Type**: `oneshot`

### Bootstrap Script
The bootstrap script installs an early hook on `android.app.Application.onCreate` to capture the very first application lifecycle event.

```javascript
module.exports = {
  start: function(params, ctx) {
    ctx.emit('bootstrap.started', {ts: ctx.stdlib.time.now()}, 'info');

    Java.perform(function() {
      var Application = Java.use('android.app.Application');
      Application.onCreate.implementation = function() {
        ctx.emit('app.onCreate', {
          className: ctx.stdlib.inspect.className(this),
          ts: ctx.stdlib.time.now()
        }, 'info');
        return this.onCreate();
      };
    });

    ctx.emit('bootstrap.complete', {ts: ctx.stdlib.time.now()}, 'info');
  }
};
```

### Spawn Result
```json
{
  "ok": true,
  "data": {
    "target_id": "tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6"
  }
}
```

**New Target ID**: `tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6`

---

## Target Status

### Status Response
```json
{
  "ok": true,
  "data": {
    "target": {
      "target_id": "tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6",
      "device_id": "2C161FDH200CY0",
      "package": "jp.naver.line.android",
      "pid": 13791,
      "mode": "spawn",
      "gating": "spawn",
      "state": "running",
      "agent_state": "ready"
    }
  }
}
```

**Key Observations**:
- Process ID: `13791` (fresh spawn)
- State: `running` (app resumed after bootstrap)
- Agent State: `ready` (orchestrator agent fully initialized)

---

## Event Timeline

### Events Captured
Total events: 5

**Event 1 - Bootstrap Job Started**
```json
{
  "event_id": "2463d617-f673-441d-aec1-0ff92c27eff1",
  "ts": "2026-01-21T06:06:10.551Z",
  "target_id": "tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6",
  "pid": 13791,
  "job_id": "job_9c990456-b430-48ce-b0de-c3101b4da1de",
  "kind": "job.started",
  "level": "info",
  "payload": {
    "job_id": "job_9c990456-b430-48ce-b0de-c3101b4da1de",
    "type": "oneshot"
  }
}
```

**Event 2 - Bootstrap Started**
```json
{
  "event_id": "30ad873f-7fab-4fc3-bb05-175284245891",
  "ts": "2026-01-21T06:06:10.552Z",
  "target_id": "tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6",
  "pid": 13791,
  "job_id": "job_9c990456-b430-48ce-b0de-c3101b4da1de",
  "kind": "bootstrap.started",
  "level": "info",
  "payload": {
    "ts": "2026-01-21T06:06:10.552Z"
  }
}
```

**Event 3 - Bootstrap Complete**
```json
{
  "event_id": "7fd301f5-0362-466a-91a0-4a0a4298fa86",
  "ts": "2026-01-21T06:06:10.716Z",
  "target_id": "tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6",
  "pid": 13791,
  "job_id": "job_9c990456-b430-48ce-b0de-c3101b4da1de",
  "kind": "bootstrap.complete",
  "level": "info",
  "payload": {
    "ts": "2026-01-21T06:06:10.716Z"
  }
}
```

**Event 4 - Bootstrap Job Completed**
```json
{
  "event_id": "5671c1b8-f052-48f3-8aa8-ef497e7d711c",
  "ts": "2026-01-21T06:06:10.716Z",
  "target_id": "tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6",
  "pid": 13791,
  "job_id": "job_9c990456-b430-48ce-b0de-c3101b4da1de",
  "kind": "job.completed",
  "level": "info",
  "payload": {
    "result": null
  }
}
```

**Event 5 - Application.onCreate Hook Triggered** ⭐
```json
{
  "event_id": "bb20a0ce-18be-4921-aab7-07011d791481",
  "ts": "2026-01-21T06:06:11.537Z",
  "target_id": "tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6",
  "pid": 13791,
  "job_id": "job_9c990456-b430-48ce-b0de-c3101b4da1de",
  "kind": "app.onCreate",
  "level": "info",
  "payload": {
    "className": "jp.naver.line.android.LineApplication",
    "ts": "2026-01-21T06:06:11.537Z"
  }
}
```

### Timeline Analysis
```
T+0.000s (06:06:10.551Z) - Bootstrap job started
T+0.001s (06:06:10.552Z) - Bootstrap execution begins
T+0.165s (06:06:10.716Z) - Bootstrap completes hook installation
T+0.165s (06:06:10.716Z) - Bootstrap job marked complete
                         [APP RESUMES AUTOMATICALLY]
T+0.986s (06:06:11.537Z) - Application.onCreate fires, hook captures it!
```

**Duration**: Bootstrap took 165ms to install hooks before app resumed

---

## Validation Results

### Checklist
- ✅ **Bootstrap runs while app suspended**: YES (events 1-4 before app.onCreate)
- ✅ **App automatically resumes after bootstrap**: YES (onCreate fired 820ms later)
- ✅ **bootstrap.started event captured**: YES (event 2, ts: 06:06:10.552Z)
- ✅ **app.onCreate event captured**: YES (event 5, ts: 06:06:11.537Z)
- ✅ **bootstrap.complete event captured**: YES (event 3, ts: 06:06:10.716Z)
- ✅ **State shows "running"**: YES
- ✅ **agent_state shows "ready"**: YES
- ✅ **Early hook captured Application.onCreate**: YES

### Critical Discovery
The bootstrap successfully hooked `Application.onCreate` and captured the very first lifecycle event. The payload reveals:

**Application Class**: `jp.naver.line.android.LineApplication`

This is LINE's custom Application subclass, indicating we've successfully intercepted the earliest possible Java-level entry point in the app's lifecycle.

---

## Key Insights

### 1. Spawn + Bootstrap Workflow
The spawn gating mechanism works as designed:
1. App process created but suspended
2. Frida orchestrator agent injected
3. Bootstrap job executes while app frozen
4. Bootstrap installs early hooks (Application.onCreate)
5. Bootstrap job completes
6. App automatically resumes
7. Hooked methods fire and are captured

### 2. Timing Precision
- Bootstrap execution: 165ms (fast, minimal delay)
- App resume to onCreate: 820ms (Android system initialization)
- Total time from spawn to first hook: ~1 second

### 3. Early Instrumentation Capability
Spawn mode with bootstrap enables instrumentation of the absolute earliest Java code execution points:
- `Application.onCreate()` - Application instance creation
- Static initializers
- Early service registration
- Initial IPC setup

This is impossible with attach mode, which can only hook methods after the app is already running.

### 4. Bootstrap vs. Regular Jobs
- **Bootstrap**: Runs while app suspended, used for early hook installation
- **Regular jobs**: Run after app resumed, used for ongoing instrumentation
- **Isolation**: Bootstrap job completes before app runs, preventing interference

---

## Comparison: Spawn vs. Attach Mode

| Aspect | Attach Mode | Spawn Mode + Bootstrap |
|--------|-------------|------------------------|
| Target state | Already running | Fresh process, suspended |
| Earliest hookable point | Methods called after attachment | Application.onCreate, static initializers |
| Process ID | Existing PID | New PID |
| App initialization | Already complete | Captured in real-time |
| Use case | Runtime analysis | Initialization analysis |
| Bootstrap requirement | Not applicable | Required for early hooks |

---

## Conclusion

**Status**: ✅ COMPLETE

Phase 2.3 successfully validated spawn mode with bootstrap gating. The mechanism works flawlessly:

1. App spawned and held in suspended state
2. Bootstrap job installed Application.onCreate hook
3. App resumed automatically after bootstrap
4. Early hook captured the first lifecycle event
5. Revealed LINE's custom Application class: `jp.naver.line.android.LineApplication`

This capability is essential for security research requiring analysis of:
- Early authentication checks
- Initial permission requests
- Native library loading sequences
- Root/tamper detection in Application.onCreate
- Early network configuration

**Next Target ID**: `tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6`
**Next Bootstrap Job ID**: `job_9c990456-b430-48ce-b0de-c3101b4da1de`
