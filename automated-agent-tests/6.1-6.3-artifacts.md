# Phase 6 - Artifact System Testing (Tests 6.1-6.3)

**Date**: 2026-01-21T06:16:08Z
**Target ID**: `tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6`
**Test Job ID**: `job_4fc7f226-ac88-4ca8-94ec-be447e33d00a`

## Test 6.3: Emit Artifacts from Job

### Objective
Validate that `ctx.emitArtifact()` API works correctly for emitting binary and JSON artifacts from instrumentation jobs, and that artifacts can be listed and retrieved with correct metadata.

---

## Test Execution Summary

### Job Configuration
- **Job Type**: `oneshot`
- **Job State**: `completed` (successfully)
- **Created**: 2026-01-21T06:16:07.082Z
- **Completed**: 2026-01-21T06:16:07.366Z
- **Duration**: ~284ms

### Artifacts Created
Two artifacts were successfully created:

#### Artifact 1: Binary Memory Dump
- **Artifact ID**: `art_07746506823546428_19c0d8b72d6`
- **Type**: `memory_dump`
- **Name**: `test_dump.bin`
- **MIME Type**: `application/octet-stream`
- **Size**: 1024 bytes
- **Stored Size**: 1024 bytes
- **SHA-256**: `785b0751fc2c53dc14a4ce3d800e69ef9ce1009eb327ccf458afe09c242c26c9`
- **Storage Reference**: `C:\Users\b33f\tools\Droid\k4hlo\kahlo-mcp\data\runs\2026-01-21\target_tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6\artifacts\art_07746506823546428_19c0d8b72d6.bin`
- **Custom Metadata**:
  ```json
  {
    "source": "test",
    "captured_at": "2026-01-21T06:16:08.662Z"
  }
  ```

#### Artifact 2: JSON Data
- **Artifact ID**: `art_6355990921005257_19c0d8b72f3`
- **Type**: `custom`
- **Name**: `test_data.json`
- **MIME Type**: `application/json`
- **Size**: 37 bytes
- **Stored Size**: 37 bytes
- **SHA-256**: `495d4782efd078b0cc03eea88c9e888eaa3d79c0efafad21cd441126014e2450`
- **Storage Reference**: `C:\Users\b33f\tools\Droid\k4hlo\kahlo-mcp\data\runs\2026-01-21\target_tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6\artifacts\art_6355990921005257_19c0d8b72f3.json`
- **Custom Metadata**: `null` (not provided)

---

## Event Flow Analysis

The job emitted the following event sequence (chronological):

### 1. Job Started
```json
{
  "event_id": "00fab6fd-b8df-4641-b824-f7c913dac7e8",
  "ts": "2026-01-21T06:16:08.661Z",
  "kind": "job.started",
  "level": "info",
  "payload": {
    "job_id": "job_4fc7f226-ac88-4ca8-94ec-be447e33d00a",
    "type": "oneshot"
  }
}
```

### 2. First Artifact (Binary) - Storage Sequence
```json
// Storage confirmation from host
{
  "event_id": "153893d3-44dc-4755-aab0-53d7ca735380",
  "ts": "2026-01-21T06:16:08.662Z",
  "kind": "artifact.stored",
  "level": "info",
  "payload": {
    "artifact_id": "art_07746506823546428_19c0d8b72d6",
    "type": "memory_dump",
    "size_bytes": 1024,
    "actual_size_bytes": 1024,
    "mime": "application/octet-stream",
    "name": "test_dump.bin",
    "metadata": {
      "source": "test",
      "captured_at": "2026-01-21T06:16:08.662Z"
    },
    "sha256": "785b0751fc2c53dc14a4ce3d800e69ef9ce1009eb327ccf458afe09c242c26c9",
    "storage_ref": "C:\\Users\\b33f\\tools\\Droid\\k4hlo\\kahlo-mcp\\data\\runs\\2026-01-21\\target_tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6\\artifacts\\art_07746506823546428_19c0d8b72d6.bin",
    "stored_size_bytes": 1024
  }
}

// Orchestrator acknowledgment
{
  "event_id": "b87adda9-f078-4057-a71a-5924f852c4a8",
  "ts": "2026-01-21T06:16:08.662Z",
  "kind": "artifact.sent",
  "level": "info",
  "payload": {
    "artifact_id": "art_07746506823546428_19c0d8b72d6",
    "size_bytes": 1024,
    "type": "memory_dump"
  }
}

// Job-level custom event
{
  "event_id": "d45cd356-9ae3-4bda-8b8f-acfd180c547b",
  "ts": "2026-01-21T06:16:08.662Z",
  "kind": "artifact.emitted",
  "level": "info",
  "payload": {
    "artifact_id": "art_07746506823546428_19c0d8b72d6",
    "size_bytes": 1024
  }
}
```

### 3. Second Artifact (JSON) - Storage Sequence
```json
// Storage confirmation
{
  "event_id": "a81df870-4871-426e-a971-ede76b65ee0d",
  "ts": "2026-01-21T06:16:08.691Z",
  "kind": "artifact.stored",
  "level": "info",
  "payload": {
    "artifact_id": "art_6355990921005257_19c0d8b72f3",
    "type": "custom",
    "size_bytes": 37,
    "actual_size_bytes": 37,
    "mime": "application/json",
    "name": "test_data.json",
    "metadata": null,
    "sha256": "495d4782efd078b0cc03eea88c9e888eaa3d79c0efafad21cd441126014e2450",
    "storage_ref": "C:\\Users\\b33f\\tools\\Droid\\k4hlo\\kahlo-mcp\\data\\runs\\2026-01-21\\target_tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6\\artifacts\\art_6355990921005257_19c0d8b72f3.json",
    "stored_size_bytes": 37
  }
}

// Orchestrator acknowledgment
{
  "event_id": "c167648e-be5a-492d-97fd-0c02d8de0082",
  "ts": "2026-01-21T06:16:08.691Z",
  "kind": "artifact.sent",
  "level": "info",
  "payload": {
    "artifact_id": "art_6355990921005257_19c0d8b72f3",
    "size_bytes": 37,
    "type": "custom"
  }
}

// Job-level custom event
{
  "event_id": "0fe3488e-da42-4b18-b046-2da26d0e310c",
  "ts": "2026-01-21T06:16:08.691Z",
  "kind": "artifact.json.emitted",
  "level": "info",
  "payload": {
    "artifact_id": "art_6355990921005257_19c0d8b72f3",
    "size_bytes": 37
  }
}
```

### 4. Job Completed
```json
{
  "event_id": "5e25f79e-d7b5-4079-80e5-642433208154",
  "ts": "2026-01-21T06:16:08.691Z",
  "kind": "job.completed",
  "level": "info",
  "payload": {
    "result": {
      "artifacts_created": 2,
      "ids": [
        "art_07746506823546428_19c0d8b72d6",
        "art_6355990921005257_19c0d8b72f3"
      ]
    }
  }
}
```

---

## Artifact Listing Results

### API Call: `kahlo_artifacts_list(target_id="tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6")`

**Result**: Successfully returned 2 artifacts with complete metadata.

```json
{
  "ok": true,
  "data": {
    "artifacts": [
      {
        "artifact_id": "art_07746506823546428_19c0d8b72d6",
        "target_id": "tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6",
        "job_id": "job_4fc7f226-ac88-4ca8-94ec-be447e33d00a",
        "ts": "2026-01-21T06:16:08.662Z",
        "type": "memory_dump",
        "size_bytes": 1024,
        "stored_size_bytes": 1024,
        "sha256": "785b0751fc2c53dc14a4ce3d800e69ef9ce1009eb327ccf458afe09c242c26c9",
        "mime": "application/octet-stream",
        "name": "test_dump.bin",
        "metadata": {
          "source": "test",
          "captured_at": "2026-01-21T06:16:08.662Z"
        },
        "storage_ref": "C:\\Users\\b33f\\tools\\Droid\\k4hlo\\kahlo-mcp\\data\\runs\\2026-01-21\\target_tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6\\artifacts\\art_07746506823546428_19c0d8b72d6.bin"
      },
      {
        "artifact_id": "art_6355990921005257_19c0d8b72f3",
        "target_id": "tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6",
        "job_id": "job_4fc7f226-ac88-4ca8-94ec-be447e33d00a",
        "ts": "2026-01-21T06:16:08.691Z",
        "type": "custom",
        "size_bytes": 37,
        "stored_size_bytes": 37,
        "sha256": "495d4782efd078b0cc03eea88c9e888eaa3d79c0efafad21cd441126014e2450",
        "mime": "application/json",
        "name": "test_data.json",
        "storage_ref": "C:\\Users\\b33f\\tools\\Droid\\k4hlo\\kahlo-mcp\\data\\runs\\2026-01-21\\target_tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6\\artifacts\\art_6355990921005257_19c0d8b72f3.json"
      }
    ]
  }
}
```

---

## Artifact Retrieval Results

### Artifact 1: Binary Memory Dump

**API Call**: `kahlo_artifacts_get(artifact_id="art_07746506823546428_19c0d8b72d6")`

**Result**: Successfully retrieved with base64-encoded payload.

```json
{
  "ok": true,
  "data": {
    "artifact": {
      "artifact_id": "art_07746506823546428_19c0d8b72d6",
      "target_id": "tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6",
      "job_id": "job_4fc7f226-ac88-4ca8-94ec-be447e33d00a",
      "ts": "2026-01-21T06:16:08.662Z",
      "type": "memory_dump",
      "size_bytes": 1024,
      "stored_size_bytes": 1024,
      "sha256": "785b0751fc2c53dc14a4ce3d800e69ef9ce1009eb327ccf458afe09c242c26c9",
      "mime": "application/octet-stream",
      "name": "test_dump.bin",
      "metadata": {
        "source": "test",
        "captured_at": "2026-01-21T06:16:08.662Z"
      },
      "storage_ref": "C:\\Users\\b33f\\tools\\Droid\\k4hlo\\kahlo-mcp\\data\\runs\\2026-01-21\\target_tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6\\artifacts\\art_07746506823546428_19c0d8b72d6.bin"
    },
    "storage_ref": "C:\\Users\\b33f\\tools\\Droid\\k4hlo\\kahlo-mcp\\data\\runs\\2026-01-21\\target_tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6\\artifacts\\art_07746506823546428_19c0d8b72d6.bin",
    "encoding": "base64",
    "payload_b64": "AAECAwQFBgcICQoLDA0ODxAREhMUFRYXGBkaGxwdHh8gISIjJCUmJygpKissLS4vMDEyMzQ1Njc4OTo7PD0+P0BBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWltcXV5fYGFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6e3x9fn+AgYKDhIWGh4iJiouMjY6PkJGSk5SVlpeYmZqbnJ2en6ChoqOkpaanqKmqq6ytrq+wsbKztLW2t7i5uru8vb6/wMHCw8TFxsfIycrLzM3Oz9DR0tPU1dbX2Nna29zd3t/g4eLj5OXm5+jp6uvs7e7v8PHy8/T19vf4+fr7/P3+/wABAgMEBQYHCAkKCwwNDg8QERITFBUWFxgZGhscHR4fICEiIyQlJicoKSorLC0uLzAxMjM0NTY3ODk6Ozw9Pj9AQUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVpbXF1eX2BhYmNkZWZnaGlqa2xtbm9wcXJzdHV2d3h5ent8fX5/gIGCg4SFhoeIiYqLjI2Oj5CRkpOUlZaXmJmam5ydnp+goaKjpKWmp6ipqqusra6vsLGys7S1tre4ubq7vL2+v8DBwsPExcbHyMnKy8zNzs/Q0dLT1NXW19jZ2tvc3d7f4OHi4+Tl5ufo6err7O3u7/Dx8vP09fb3+Pn6+/z9/v8AAQIDBAUGBwgJCgsMDQ4PEBESExQVFhcYGRobHB0eHyAhIiMkJSYnKCkqKywtLi8wMTIzNDU2Nzg5Ojs8PT4/QEFCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaW1xdXl9gYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXp7fH1+f4CBgoOEhYaHiImKi4yNjo+QkZKTlJWWl5iZmpucnZ6foKGio6SlpqeoqaqrrK2ur7CxsrO0tba3uLm6u7y9vr/AwcLDxMXGx8jJysvMzc7P0NHS09TV1tfY2drb3N3e3+Dh4uPk5ebn6Onq6+zt7u/w8fLz9PX29/j5+vv8/f7/AAECAwQFBgcICQoLDA0ODxAREhMUFRYXGBkaGxwdHh8gISIjJCUmJygpKissLS4vMDEyMzQ1Njc4OTo7PD0+P0BBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWltcXV5fYGFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6e3x9fn+AgYKDhIWGh4iJiouMjY6PkJGSk5SVlpeYmZqbnJ2en6ChoqOkpaanqKmqq6ytrq+wsbKztLW2t7i5uru8vb6/wMHCw8TFxsfIycrLzM3Oz9DR0tPU1dbX2Nna29zd3t/g4eLj5OXm5+jp6uvs7e7v8PHy8/T19vf4+fr7/P3+/w=="
  }
}
```

**Payload Validation**: The base64 payload decodes to 1024 bytes with the expected pattern (0-255 repeating 4 times), confirming correct binary data transmission.

### Artifact 2: JSON Data

**API Call**: `kahlo_artifacts_get(artifact_id="art_6355990921005257_19c0d8b72f3")`

**Result**: Successfully retrieved with base64-encoded JSON payload.

```json
{
  "ok": true,
  "data": {
    "artifact": {
      "artifact_id": "art_6355990921005257_19c0d8b72f3",
      "target_id": "tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6",
      "job_id": "job_4fc7f226-ac88-4ca8-94ec-be447e33d00a",
      "ts": "2026-01-21T06:16:08.691Z",
      "type": "custom",
      "size_bytes": 37,
      "stored_size_bytes": 37,
      "sha256": "495d4782efd078b0cc03eea88c9e888eaa3d79c0efafad21cd441126014e2450",
      "mime": "application/json",
      "name": "test_data.json",
      "storage_ref": "C:\\Users\\b33f\\tools\\Droid\\k4hlo\\kahlo-mcp\\data\\runs\\2026-01-21\\target_tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6\\artifacts\\art_6355990921005257_19c0d8b72f3.json"
    },
    "storage_ref": "C:\\Users\\b33f\\tools\\Droid\\k4hlo\\kahlo-mcp\\data\\runs\\2026-01-21\\target_tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6\\artifacts\\art_6355990921005257_19c0d8b72f3.json",
    "encoding": "base64",
    "payload_b64": "eyJ0ZXN0IjoiZGF0YSIsIm5lc3RlZCI6eyJ2YWx1ZSI6NDJ9fQ=="
  }
}
```

**Payload Validation**: Base64 decodes to:
```json
{"test":"data","nested":{"value":42}}
```

This matches the expected JSON structure created in the test job.

---

## Validation Checklist

### ✅ ctx.emitArtifact Return Values
- **PASS**: Returns `artifact_id` for both artifacts
  - Artifact 1: `art_07746506823546428_19c0d8b72d6`
  - Artifact 2: `art_6355990921005257_19c0d8b72f3`
- **PASS**: Returns `size_bytes` for both artifacts
  - Artifact 1: 1024 bytes
  - Artifact 2: 37 bytes

### ✅ Artifacts Appear in List
- **PASS**: `kahlo_artifacts_list()` returns both artifacts
- **PASS**: Correct metadata preserved:
  - Artifact IDs
  - Timestamps
  - Types (memory_dump, custom)
  - Names (test_dump.bin, test_data.json)
  - MIME types (application/octet-stream, application/json)
  - Sizes
  - SHA-256 hashes
  - Storage references
  - Custom metadata (where provided)

### ✅ Artifacts Retrievable with Correct Content
- **PASS**: Both artifacts successfully retrieved via `kahlo_artifacts_get()`
- **PASS**: Binary artifact content correct (1024 bytes, 0-255 pattern × 4)
- **PASS**: JSON artifact content correct (`{"test":"data","nested":{"value":42}}`)
- **PASS**: Base64 encoding used for payload transmission

### ✅ Different MIME Types Handled
- **PASS**: `application/octet-stream` handled correctly for binary data
- **PASS**: `application/json` handled correctly for JSON data
- **PASS**: File extensions match MIME types (.bin, .json)
- **PASS**: Both types stored on disk with appropriate naming

---

## Storage Architecture Observations

### File Naming Convention
```
art_<numeric_id>_<short_hash>.<extension>
```
Example:
- `art_07746506823546428_19c0d8b72d6.bin`
- `art_6355990921005257_19c0d8b72f3.json`

### Directory Structure
```
kahlo-mcp/
  data/
    runs/
      2026-01-21/
        target_tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6/
          artifacts/
            art_07746506823546428_19c0d8b72d6.bin
            art_6355990921005257_19c0d8b72f3.json
```

Artifacts are organized by:
1. Date (YYYY-MM-DD)
2. Target ID
3. Individual artifact files

### Integrity Protection
- SHA-256 hashes computed for all artifacts
- Size validation (size_bytes vs stored_size_bytes)
- Timestamp tracking for forensic purposes

---

## API Behavior Analysis

### ctx.emitArtifact() Synchronicity
The artifact emission appears to be **synchronous**:
- Job code calls `ctx.emitArtifact()`
- Artifact is transmitted to host
- Host stores artifact to disk
- Host emits `artifact.stored` event
- Host emits `artifact.sent` acknowledgment
- Control returns to job with artifact_id and size_bytes
- Job can immediately emit custom events referencing the artifact_id

Time delta between binary artifact emission and JSON artifact emission: **29ms**, indicating fast, synchronous processing.

### Event Sequencing
For each artifact, the system emits 3 events:
1. **artifact.stored** (host-level): Full metadata including storage_ref and SHA-256
2. **artifact.sent** (orchestrator-level): Acknowledgment with artifact_id
3. **Custom event** (job-level): Application-defined event (e.g., `artifact.emitted`)

This multi-layer event model provides comprehensive audit trail and debugging visibility.

---

## Performance Metrics

| Metric | Value |
|--------|-------|
| Job execution time | ~284ms |
| Binary artifact (1KB) emission time | < 1ms |
| JSON artifact (37B) emission time | < 29ms |
| Total artifacts created | 2 |
| Total data transferred | 1061 bytes |
| Events emitted | 8 |

---

## Findings Summary

### Successful Functionality
1. **Artifact Emission**: `ctx.emitArtifact()` API works correctly for both binary and JSON data
2. **Return Values**: Correctly returns `artifact_id` and `size_bytes` for immediate reference
3. **Metadata Preservation**: Custom metadata, MIME types, names, and types all preserved
4. **Listing**: `kahlo_artifacts_list()` correctly returns all artifacts with full metadata
5. **Retrieval**: `kahlo_artifacts_get()` successfully retrieves artifacts with base64-encoded payloads
6. **Content Integrity**: SHA-256 hashes and size validation ensure data integrity
7. **Storage**: Artifacts stored to disk with logical directory structure and naming

### No Obstacles Encountered
All test operations completed successfully without errors or unexpected behaviors.

---

## Status: COMPLETE

All validation criteria met. Artifact system fully functional for emission, listing, and retrieval of both binary and JSON data types.
