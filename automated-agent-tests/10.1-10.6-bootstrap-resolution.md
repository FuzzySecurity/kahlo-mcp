# Phase 10.1-10.6 - Bootstrap Resolution (draft_id & module_ref)

**Objective**: Test bootstrap resolution in `kahlo_targets_ensure` for all three `bootstrap.kind` values: `source` (regression), `draft_id` (newly implemented), and `module_ref` (newly implemented). Covers positive, negative, and edge cases.

**Date**: 2026-01-24 (Executed: 2026-01-24T03:12:00Z)

**Device ID**: `2C161FDH200CY0`
**Package**: `jp.naver.line.android`

---

## Background

Prior to this feature, `kahlo_targets_ensure` with `gating="spawn"` only supported `bootstrap={kind:"source", source:"..."}` for inline JavaScript. The `draft_id` and `module_ref` kinds threw `NOT_IMPLEMENTED` errors.

With bootstrap resolution implemented, `resolveBootstrapSource()` now resolves source code from:
1. **Inline source** (`kind:"source"`) - returns `bootstrap.source` directly
2. **Draft reference** (`kind:"draft_id"`) - calls `getDraft()` and returns `draft.source`
3. **Module reference** (`kind:"module_ref"`) - calls `getModule()` and returns `module.source`

This test phase validates all three paths including error handling for missing drafts/modules.

---

## Execution Summary

**Execution Date**: 2026-01-24
**Device**: 2C161FDH200CY0 (Pixel 7, USB, healthy)
**Overall Status**: ALL PASS (6/6)

**Results**:
- ✓ Test 10.1 (draft_id positive): PASS
- ✓ Test 10.2 (module_ref positive): PASS
- ✓ Test 10.3 (draft_id negative): PASS
- ✓ Test 10.4 (module_ref negative): PASS
- ✓ Test 10.5 (source regression): PASS
- ✓ Test 10.6 (edge case): PASS

**Key Findings**:
1. Bootstrap resolution for `draft_id` and `module_ref` is successfully implemented and functional
2. All three bootstrap kinds (`source`, `draft_id`, `module_ref`) work correctly for valid inputs
3. Nonexistent `draft_id` correctly returns synchronous NOT_FOUND error
4. Nonexistent `module_ref` correctly returns synchronous NOT_FOUND error
5. Empty module source fails gracefully with clear error message
6. No regressions in existing inline `source` bootstrap path

---

## Setup

### 1. Detach Any Previous Target

**Command**: `kahlo_targets_detach(target_id="<previous>")`

**Result**: Detached or skipped (no active target)

### 2. Force Stop LINE Application

**Command**: `kahlo_adb_command(device_id="2C161FDH200CY0", command=["shell", "am", "force-stop", "jp.naver.line.android"])`

**Result**:
```json
{
  "ok": true,
  "data": {
    "stdout": "",
    "command": "shell am force-stop jp.naver.line.android",
    "device_id": "2C161FDH200CY0"
  }
}
```

---

## Test 10.1 - Spawn with Bootstrap kind:"draft_id" (Positive)

### Objective
Create a draft module, then use its `draft_id` as the bootstrap for `gating="spawn"`. The server should resolve the draft's source and use it as the bootstrap job.

### Step 1: Create Draft for Bootstrap

**Command**:
```javascript
kahlo_modules_createDraft(
  name="bootstrap-draft-test",
  source="module.exports = {\n  start: function(params, ctx) {\n    ctx.emit('draft.bootstrap.started', {kind: 'draft_id', ts: ctx.stdlib.time.now()}, 'info');\n\n    Java.perform(function() {\n      var Application = Java.use('android.app.Application');\n      Application.onCreate.implementation = function() {\n        ctx.emit('app.onCreate', {\n          source: 'draft-bootstrap',\n          className: ctx.stdlib.inspect.className(this),\n          ts: ctx.stdlib.time.now()\n        }, 'info');\n        return this.onCreate();\n      };\n    });\n\n    ctx.emit('draft.bootstrap.complete', {ts: ctx.stdlib.time.now()}, 'info');\n  }\n};"
)
```

**Result**:
```json
{
  "ok": true,
  "data": {
    "draft_id": "draft_99275a44-192c-4d2c-ad88-c93e2e955dfc",
    "draft": {
      "draft_id": "draft_99275a44-192c-4d2c-ad88-c93e2e955dfc",
      "name": "bootstrap-draft-test",
      "created_at": "2026-01-24T03:12:29.199Z",
      "updated_at": "2026-01-24T03:12:29.199Z"
    }
  }
}
```

**Draft ID**: `draft_99275a44-192c-4d2c-ad88-c93e2e955dfc`

### Step 2: Spawn with draft_id Bootstrap

**Command**:
```javascript
kahlo_targets_ensure(
  device_id="2C161FDH200CY0",
  package="jp.naver.line.android",
  mode="spawn",
  gating="spawn",
  bootstrap={kind: "draft_id", draft_id: "draft_99275a44-192c-4d2c-ad88-c93e2e955dfc"},
  bootstrap_type="oneshot"
)
```

**Actual Result**:
```json
{
  "ok": true,
  "data": {
    "target_id": "tgt_a482a430-6395-463f-859b-fc6f63d64a91"
  }
}
```

**Key Assertions**:
- ✓ `ok` is `true` -- draft source resolved successfully
- ✓ `target_id` returned -- process spawned and instrumented
- ✓ No `NOT_IMPLEMENTED` error -- resolution path is active

### Step 3: Verify Target Status

**Command**:
```javascript
kahlo_targets_status(target_id="tgt_a482a430-6395-463f-859b-fc6f63d64a91")
```

**Actual Result**:
```json
{
  "ok": true,
  "data": {
    "target": {
      "target_id": "tgt_a482a430-6395-463f-859b-fc6f63d64a91",
      "device_id": "2C161FDH200CY0",
      "package": "jp.naver.line.android",
      "pid": 17552,
      "mode": "spawn",
      "gating": "spawn",
      "state": "running",
      "agent_state": "ready"
    }
  }
}
```

**Key Assertions**:
- ✓ `state`: `"running"` (app resumed after bootstrap)
- ✓ `agent_state`: `"ready"` (orchestrator injected successfully)
- ✓ `gating`: `"spawn"` (bootstrap ran while app was suspended)

### Step 4: Verify Bootstrap Events

**Command**:
```javascript
kahlo_events_fetch(target_id="tgt_a482a430-6395-463f-859b-fc6f63d64a91", limit=10)
```

**Actual Events** (in order):
1. `job.started` - Bootstrap job began execution
2. `draft.bootstrap.started` - Custom event from draft bootstrap code (`kind: "draft_id"`)
3. `draft.bootstrap.complete` - Bootstrap finished installing hooks
4. `job.completed` - Bootstrap job completed
5. `app.onCreate` - Application.onCreate hook fired after resume (`source: "draft-bootstrap"`, `className: "jp.naver.line.android.LineApplication"`)

**Key Assertions**:
- ✓ `draft.bootstrap.started` event contains `{kind: "draft_id"}` confirming draft source was used
- ✓ `app.onCreate` event contains `{source: "draft-bootstrap"}` proving the draft's code executed
- ✓ Bootstrap events occur BEFORE `app.onCreate` (app was suspended during bootstrap)

### Step 5: Cleanup

**Command**: `kahlo_targets_detach(target_id="tgt_a482a430-6395-463f-859b-fc6f63d64a91")`

**Result**:
```json
{
  "ok": true,
  "data": {
    "target_id": "tgt_a482a430-6395-463f-859b-fc6f63d64a91",
    "state": "detached"
  }
}
```

### Test 10.1 Validation

- [x] Draft created successfully with `draft_id`
- [x] `kahlo_targets_ensure` succeeds with `bootstrap={kind:"draft_id", draft_id:"..."}`
- [x] Target state shows `"running"` and `agent_state` shows `"ready"`
- [x] Bootstrap events confirm draft source was resolved and executed
- [x] `app.onCreate` captured (early hook installed successfully)
- [x] Target detached cleanly

**STATUS: PASS**

---

## Test 10.2 - Spawn with Bootstrap kind:"module_ref" (Positive)

### Objective
Create and promote a versioned module, then use its `module_ref` as the bootstrap for `gating="spawn"`. The server should resolve the module's source and use it as the bootstrap job.

### Step 1: Force Stop LINE Application

**Command**: `kahlo_adb_command(device_id="2C161FDH200CY0", command=["shell", "am", "force-stop", "jp.naver.line.android"])`

**Result**:
```json
{
  "ok": true,
  "data": {
    "stdout": "",
    "command": "shell am force-stop jp.naver.line.android",
    "device_id": "2C161FDH200CY0"
  }
}
```

### Step 2: Create Draft for Promotion

**Command**:
```javascript
kahlo_modules_createDraft(
  name="bootstrap-module-test",
  source="module.exports = {\n  start: function(params, ctx) {\n    ctx.emit('module.bootstrap.started', {kind: 'module_ref', ts: ctx.stdlib.time.now()}, 'info');\n\n    Java.perform(function() {\n      var Application = Java.use('android.app.Application');\n      Application.onCreate.implementation = function() {\n        ctx.emit('app.onCreate', {\n          source: 'module-bootstrap',\n          className: ctx.stdlib.inspect.className(this),\n          ts: ctx.stdlib.time.now()\n        }, 'info');\n        return this.onCreate();\n      };\n    });\n\n    ctx.emit('module.bootstrap.complete', {ts: ctx.stdlib.time.now()}, 'info');\n  }\n};"
)
```

**Result**:
```json
{
  "ok": true,
  "data": {
    "draft_id": "draft_a434b2df-0f20-4e69-b50a-a5f55a6d2ec5",
    "draft": {
      "draft_id": "draft_a434b2df-0f20-4e69-b50a-a5f55a6d2ec5",
      "name": "bootstrap-module-test",
      "created_at": "2026-01-24T03:13:03.324Z",
      "updated_at": "2026-01-24T03:13:03.324Z"
    }
  }
}
```

### Step 3: Promote Draft to Versioned Module

**Command**:
```javascript
kahlo_modules_promoteDraft(
  draft_id="draft_a434b2df-0f20-4e69-b50a-a5f55a6d2ec5",
  name="test.bootstrap.hook",
  version_strategy="major"
)
```

**Result**:
```json
{
  "ok": true,
  "data": {
    "module_ref": "test.bootstrap.hook@1.0.0"
  }
}
```

**Module Reference**: `test.bootstrap.hook@1.0.0`

### Step 4: Verify Module in Store

**Command**:
```javascript
kahlo_modules_get(module_ref="test.bootstrap.hook@1.0.0")
```

**Actual Result**:
```json
{
  "ok": true,
  "data": {
    "module": {
      "module_ref": "test.bootstrap.hook@1.0.0",
      "name": "test.bootstrap.hook",
      "version": "1.0.0",
      "source": "module.exports = {...full source code...}",
      "created_at": "2026-01-24T03:13:07.589Z",
      "provenance": {
        "derived_from_draft_id": "draft_a434b2df-0f20-4e69-b50a-a5f55a6d2ec5"
      }
    }
  }
}
```

**Key Assertion**: ✓ Module exists in store with full source code, ready for bootstrap resolution.

### Step 5: Spawn with module_ref Bootstrap

**Command**:
```javascript
kahlo_targets_ensure(
  device_id="2C161FDH200CY0",
  package="jp.naver.line.android",
  mode="spawn",
  gating="spawn",
  bootstrap={kind: "module_ref", module_ref: "test.bootstrap.hook@1.0.0"},
  bootstrap_type="oneshot"
)
```

**Actual Result**:
```json
{
  "ok": true,
  "data": {
    "target_id": "tgt_8f9b83ee-1931-446e-a9e4-68fe8a44e0d4"
  }
}
```

**Key Assertions**:
- ✓ `ok` is `true` -- module source resolved successfully from versioned store
- ✓ `target_id` returned -- process spawned and instrumented
- ✓ No `NOT_IMPLEMENTED` error -- module_ref resolution path is active

### Step 6: Verify Target Status

**Command**:
```javascript
kahlo_targets_status(target_id="tgt_8f9b83ee-1931-446e-a9e4-68fe8a44e0d4")
```

**Actual Result**:
```json
{
  "ok": true,
  "data": {
    "target": {
      "target_id": "tgt_8f9b83ee-1931-446e-a9e4-68fe8a44e0d4",
      "device_id": "2C161FDH200CY0",
      "package": "jp.naver.line.android",
      "pid": 17917,
      "mode": "spawn",
      "gating": "spawn",
      "state": "running",
      "agent_state": "ready"
    }
  }
}
```

### Step 7: Verify Bootstrap Events

**Command**:
```javascript
kahlo_events_fetch(target_id="tgt_8f9b83ee-1931-446e-a9e4-68fe8a44e0d4", limit=10)
```

**Actual Events** (in order):
1. `job.started` - Bootstrap job began
2. `module.bootstrap.started` - Custom event from module bootstrap code (`kind: "module_ref"`)
3. `module.bootstrap.complete` - Bootstrap finished installing hooks
4. `job.completed` - Bootstrap job completed
5. `app.onCreate` - Application.onCreate hook fired after resume (`source: "module-bootstrap"`, `className: "jp.naver.line.android.LineApplication"`)

**Key Assertions**:
- ✓ `module.bootstrap.started` event contains `{kind: "module_ref"}` confirming module source was used
- ✓ `app.onCreate` event contains `{source: "module-bootstrap"}` proving the module's code executed
- ✓ Event ordering confirms bootstrap ran while app was suspended

### Step 8: Cleanup

**Command**: `kahlo_targets_detach(target_id="tgt_8f9b83ee-1931-446e-a9e4-68fe8a44e0d4")`

### Test 10.2 Validation

- [x] Draft created and promoted to versioned module `test.bootstrap.hook@1.0.0`
- [x] Module retrievable from store with source code
- [x] `kahlo_targets_ensure` succeeds with `bootstrap={kind:"module_ref", module_ref:"test.bootstrap.hook@1.0.0"}`
- [x] Target state shows `"running"` and `agent_state` shows `"ready"`
- [x] Bootstrap events confirm module source was resolved and executed
- [x] `app.onCreate` captured (early hook installed successfully from module source)
- [x] Target detached cleanly

**STATUS: PASS**

---

## Test 10.3 - Nonexistent draft_id Bootstrap (Negative)

### Objective
Attempt `gating="spawn"` with a `draft_id` that does not exist. The server should return a `NOT_FOUND` error without spawning or crashing.

### Step 1: Force Stop LINE Application

**Command**: `kahlo_adb_command(device_id="2C161FDH200CY0", command=["shell", "am", "force-stop", "jp.naver.line.android"])`

**Result**:
```json
{
  "ok": true,
  "data": {
    "stdout": "",
    "command": "shell am force-stop jp.naver.line.android",
    "device_id": "2C161FDH200CY0"
  }
}
```

### Step 2: Spawn with Nonexistent draft_id

**Command**:
```javascript
kahlo_targets_ensure(
  device_id="2C161FDH200CY0",
  package="jp.naver.line.android",
  mode="spawn",
  gating="spawn",
  bootstrap={kind: "draft_id", draft_id: "nonexistent_draft"},
  bootstrap_type="oneshot"
)
```

**Actual Result**:
```json
{
  "ok": false,
  "error": {
    "code": "NOT_FOUND",
    "tool": "kahlo_targets_ensure",
    "message": "Bootstrap draft not found: nonexistent_draft",
    "retryable": false,
    "details": {
      "draft_id": "nonexistent_draft",
      "hint": "Verify the draft exists using kahlo_modules_listDrafts"
    },
    "suggestion": "Verify device_id using kahlo_devices_list"
  }
}
```

**Key Assertions**:
- ✓ `ok` is `false` -- the operation failed as expected
- ✓ `code` is `"NOT_FOUND"` -- the draft_id could not be resolved
- ✓ Error message references the missing draft_id
- ✓ No process was spawned (failure occurs during bootstrap resolution, before spawn or after spawn cleanup)

### Analysis
The `resolveBootstrapSource()` function calls `getDraft(draft_id)` which throws `DraftManagerError` with code `NOT_FOUND`. This is caught and re-thrown as a `TargetManagerError` with code `NOT_FOUND`, which the tool handler in `targets.ts` maps to the error response above.

### Test 10.3 Validation

- [x] `kahlo_targets_ensure` returns error (not success)
- [x] Error code is `NOT_FOUND`
- [x] Error message references the nonexistent draft_id
- [x] No orphaned spawned process left behind

**STATUS: PASS** (Negative test - error expected and received)

---

## Test 10.4 - Nonexistent module_ref Bootstrap (Negative)

### Objective
Attempt `gating="spawn"` with a `module_ref` that does not exist in the module store. The server should return a `NOT_FOUND` error.

### Step 1: Spawn with Nonexistent module_ref

**Command**:
```javascript
kahlo_targets_ensure(
  device_id="2C161FDH200CY0",
  package="jp.naver.line.android",
  mode="spawn",
  gating="spawn",
  bootstrap={kind: "module_ref", module_ref: "nonexistent@1.0.0"},
  bootstrap_type="oneshot"
)
```

**Actual Result**:
```json
{
  "ok": false,
  "error": {
    "code": "NOT_FOUND",
    "tool": "kahlo_targets_ensure",
    "message": "Bootstrap module not found: nonexistent@1.0.0",
    "retryable": false,
    "details": {
      "module_ref": "nonexistent@1.0.0",
      "hint": "Verify the module exists using kahlo_modules_list"
    }
  }
}
```

**Key Assertions**:
- ✓ `ok` is `false` — the operation failed as expected
- ✓ `code` is `"NOT_FOUND"` — module_ref could not be resolved
- ✓ Error message references the missing module_ref
- ✓ No process spawned (pre-flight validation rejects before `device.spawn()`)
- ✓ No target_id in response

### Test 10.4 Validation

- [x] `kahlo_targets_ensure` returns error (not success)
- [x] Error code is `NOT_FOUND`
- [x] Error message references the nonexistent module_ref `nonexistent@1.0.0`
- [x] No orphaned spawned process left behind

**STATUS: PASS**

---

## Test 10.5 - Inline source Bootstrap Regression (Positive)

### Objective
Verify that the original `kind:"source"` bootstrap path still works correctly after the `resolveBootstrapSource()` refactoring. This is a regression test.

### Step 1: Force Stop LINE Application

**Command**: `kahlo_adb_command(device_id="2C161FDH200CY0", command=["shell", "am", "force-stop", "jp.naver.line.android"])`

**Result**:
```json
{
  "ok": true,
  "data": {
    "stdout": "",
    "command": "shell am force-stop jp.naver.line.android",
    "device_id": "2C161FDH200CY0"
  }
}
```

### Step 2: Spawn with Inline Source Bootstrap

**Command**:
```javascript
kahlo_targets_ensure(
  device_id="2C161FDH200CY0",
  package="jp.naver.line.android",
  mode="spawn",
  gating="spawn",
  bootstrap={
    kind: "source",
    source: "module.exports = {\n  start: function(params, ctx) {\n    ctx.emit('inline.bootstrap.started', {kind: 'source', ts: ctx.stdlib.time.now()}, 'info');\n\n    Java.perform(function() {\n      var Application = Java.use('android.app.Application');\n      Application.onCreate.implementation = function() {\n        ctx.emit('app.onCreate', {\n          source: 'inline-bootstrap',\n          className: ctx.stdlib.inspect.className(this),\n          ts: ctx.stdlib.time.now()\n        }, 'info');\n        return this.onCreate();\n      };\n    });\n\n    ctx.emit('inline.bootstrap.complete', {ts: ctx.stdlib.time.now()}, 'info');\n  }\n};"
  },
  bootstrap_type="oneshot"
)
```

**Actual Result**:
```json
{
  "ok": true,
  "data": {
    "target_id": "tgt_57baf9d3-97a6-4f0a-ba90-ada1458c95cd"
  }
}
```

### Step 3: Verify Target Status

**Command**:
```javascript
kahlo_targets_status(target_id="tgt_57baf9d3-97a6-4f0a-ba90-ada1458c95cd")
```

**Actual Result**:
```json
{
  "ok": true,
  "data": {
    "target": {
      "target_id": "tgt_57baf9d3-97a6-4f0a-ba90-ada1458c95cd",
      "device_id": "2C161FDH200CY0",
      "package": "jp.naver.line.android",
      "pid": 18469,
      "mode": "spawn",
      "gating": "spawn",
      "state": "running",
      "agent_state": "ready"
    }
  }
}
```

### Step 4: Verify Bootstrap Events

**Command**:
```javascript
kahlo_events_fetch(target_id="tgt_57baf9d3-97a6-4f0a-ba90-ada1458c95cd", limit=10)
```

**Actual Events**:
1. `job.started` - Bootstrap job began
2. `inline.bootstrap.started` - Custom event from inline bootstrap code (`kind: "source"`)
3. `inline.bootstrap.complete` - Bootstrap finished
4. `job.completed` - Bootstrap job completed
5. `app.onCreate` - Application.onCreate hook fired (`source: "inline-bootstrap"`, `className: "jp.naver.line.android.LineApplication"`)

**Key Assertions**:
- ✓ Inline source bootstrap still works identically to Phase 2.3
- ✓ `inline.bootstrap.started` event contains `{kind: "source"}` confirming inline path
- ✓ `app.onCreate` event captured with `{source: "inline-bootstrap"}`
- ✓ No regression from resolveBootstrapSource refactoring

### Step 5: Cleanup

**Command**: `kahlo_targets_detach(target_id="tgt_57baf9d3-97a6-4f0a-ba90-ada1458c95cd")`

### Test 10.5 Validation

- [x] `kahlo_targets_ensure` succeeds with `bootstrap={kind:"source", source:"..."}`
- [x] Target state shows `"running"` and `agent_state` shows `"ready"`
- [x] Bootstrap events confirm inline source was used
- [x] `app.onCreate` captured (early hook installed)
- [x] No regression from Phase 2.3 behavior

**STATUS: PASS** (Regression test - inline source continues to work)

---

## Test 10.6 - Empty/Minimal Source Draft as Bootstrap (Edge Case)

### Objective
Create a draft with minimal/trivial source code (no valid `module.exports` contract), then attempt to use it as a bootstrap. The bootstrap job should fail gracefully -- either with an `INVALID_ARGUMENT` error during resolution or with a bootstrap job failure that is reported cleanly.

### Step 1: Create Draft with Empty Module

**Command**:
```javascript
kahlo_modules_createDraft(
  name="empty-bootstrap-test",
  source="module.exports = {};"
)
```

**Result**:
```json
{
  "ok": true,
  "data": {
    "draft_id": "draft_9fd82098-13f3-42ce-a65c-0d9b619779ef",
    "draft": {
      "draft_id": "draft_9fd82098-13f3-42ce-a65c-0d9b619779ef",
      "name": "empty-bootstrap-test",
      "created_at": "2026-01-24T03:14:32.794Z",
      "updated_at": "2026-01-24T03:14:32.794Z"
    }
  }
}
```

**Draft ID**: `draft_9fd82098-13f3-42ce-a65c-0d9b619779ef`

### Step 2: Force Stop LINE Application

**Command**: `kahlo_adb_command(device_id="2C161FDH200CY0", command=["shell", "am", "force-stop", "jp.naver.line.android"])`

### Step 3: Spawn with Empty Draft Bootstrap

**Command**:
```javascript
kahlo_targets_ensure(
  device_id="2C161FDH200CY0",
  package="jp.naver.line.android",
  mode="spawn",
  gating="spawn",
  bootstrap={kind: "draft_id", draft_id: "draft_9fd82098-13f3-42ce-a65c-0d9b619779ef"},
  bootstrap_type="oneshot"
)
```

**Actual Result** - Outcome A (Bootstrap Job Fails Gracefully):

```json
{
  "ok": false,
  "error": {
    "code": "UNAVAILABLE",
    "tool": "kahlo_targets_ensure",
    "message": "Bootstrap job failed: Module missing required function: start(params, ctx)",
    "retryable": true,
    "details": {
      "target_id": "tgt_7193cc11-da21-49cc-ad44-241360e39d0e",
      "pid": 18708,
      "package": "jp.naver.line.android"
    },
    "suggestion": "Check device connection with kahlo_devices_health"
  }
}
```

**Key Assertions**:
- ✓ The server does NOT crash or hang
- ✓ The operation fails with error code `"UNAVAILABLE"` (bootstrap job failure), not `"INTERNAL"`
- ✓ Error message clearly explains the problem: "Module missing required function: start(params, ctx)"
- ✓ No orphaned spawned processes are left behind (verified via process list - jp.naver.line.android not running)

### Analysis

This edge case tests the boundary between source resolution (which succeeds -- the draft exists and has source) and bootstrap execution (which may fail -- the source lacks the required `start()` function). The critical property is graceful failure: the server must not leave orphaned processes or enter an inconsistent state regardless of which outcome occurs.

The specific outcome depends on how `startBootstrapJob` and the orchestrator handle modules without a `start` function:
- If the orchestrator validates the module contract and rejects it, Outcome A occurs
- If the orchestrator treats a missing `start` as a no-op, Outcome B occurs

### Step 4: Cleanup

Outcome A occurred (error response), so no detachment needed.

### Test 10.6 Validation

- [x] Draft with minimal source created successfully
- [x] `kahlo_targets_ensure` either fails gracefully (Outcome A) or succeeds with no-op bootstrap (Outcome B) - **Outcome A occurred**
- [x] Server does not crash or hang
- [x] No orphaned spawned processes left behind
- [x] Error response (if any) has a meaningful error code and message

**STATUS: PASS** (Edge case - graceful failure with clear error message)

---

## Validation Checklist (All Tests)

### Positive Cases
- [x] **10.1**: `kind:"draft_id"` bootstrap resolves source from draft store and executes successfully - **PASS**
- [x] **10.2**: `kind:"module_ref"` bootstrap resolves source from module store and executes successfully - **PASS**
- [x] **10.5**: `kind:"source"` bootstrap continues to work (regression test) - **PASS**

### Negative Cases
- [x] **10.3**: Nonexistent `draft_id` returns `NOT_FOUND` error - **PASS**
- [x] **10.4**: Nonexistent `module_ref` returns `NOT_FOUND` error - **PASS**

### Edge Cases
- [x] **10.6**: Empty/minimal source draft handled gracefully (no crash, no orphaned processes) - **PASS**

### Cross-Cutting Concerns
- [x] No `NOT_IMPLEMENTED` errors for `draft_id` or `module_ref` kinds (feature is implemented)
- [x] Error codes are appropriate: `NOT_FOUND` for missing resources, `UNAVAILABLE` for runtime failures
- [x] No orphaned spawned processes in any failure scenario
- [x] All three bootstrap resolution paths (`source`, `draft_id`, `module_ref`) are functionally equivalent once source is resolved

---

## Expected resolveBootstrapSource Implementation

For reference, the expected behavior of the updated `resolveBootstrapSource()` function:

```
Input: bootstrap={kind:"source", source:"<code>"}
  -> Returns "<code>" directly

Input: bootstrap={kind:"draft_id", draft_id:"<valid_id>"}
  -> Calls getDraft(draft_id)
  -> Returns draft.source
  -> Throws NOT_FOUND if draft doesn't exist

Input: bootstrap={kind:"module_ref", module_ref:"<valid_ref>"}
  -> Calls getModule(module_ref)
  -> Returns module.source
  -> Throws NOT_FOUND if module doesn't exist

Input: bootstrap={kind:"draft_id", draft_id:undefined}
  -> Returns null (invalid specification)
  -> Caller throws INVALID_ARGUMENT
```

---

## Summary

**Status**: ALL PASS (6/6)

**Execution Date**: 2026-01-24

**Device**: 2C161FDH200CY0 (Pixel 7, healthy)

Phase 10.1-10.6 defines 6 test scenarios for the bootstrap resolution feature:

| Test | Kind | Scenario | Expected Outcome | Actual Result |
|------|------|----------|-----------------|---------------|
| 10.1 | `draft_id` | Valid draft as bootstrap | SUCCESS - draft source resolved and executed | **PASS** ✓ |
| 10.2 | `module_ref` | Valid module as bootstrap | SUCCESS - module source resolved and executed | **PASS** ✓ |
| 10.3 | `draft_id` | Nonexistent draft | NOT_FOUND error | **PASS** ✓ |
| 10.4 | `module_ref` | Nonexistent module | NOT_FOUND error | **PASS** ✓ |
| 10.5 | `source` | Inline source (regression) | SUCCESS - existing behavior preserved | **PASS** ✓ |
| 10.6 | `draft_id` | Empty/minimal source draft | Graceful failure or no-op bootstrap | **PASS** ✓ (Outcome A) |

### Dependencies
- Tests 10.1-10.6 require `resolveBootstrapSource()` to be rewritten (Task #3) to call `getDraft()` and `getModule()` instead of throwing `NOT_IMPLEMENTED`
- Tests 10.3-10.4 require error propagation from `DraftManagerError`/`ModuleStoreError` to `TargetManagerError` with code `NOT_FOUND`
- Test 10.5 requires no changes (regression test for existing behavior)

### Relationship to Other Phases
- **Phase 2.3** (Spawn with Bootstrap): Tests 10.1, 10.2, and 10.5 extend Phase 2.3 by testing non-inline bootstrap sources
- **Phase 7.1-7.6** (Module Drafts): Test 10.1 depends on draft creation from Phase 7
- **Phase 7.7-7.9** (Module Promotion): Test 10.2 depends on module promotion from Phase 7

---

**End of Phase 10.1-10.6**
