# Phase 8.1-8.3: Stdlib Testing (stack, inspect, classes)

## Task Understanding
Test comprehensive stdlib functionality for stack tracing, object inspection, and class discovery/loading utilities in the Kahlo framework.

## Methodology
Executed a oneshot job that exercises all stdlib.stack, stdlib.inspect, and stdlib.classes APIs against the running LINE application. The job captured stack traces, inspected Activity instances, discovered classes by prefix, and tested safe class loading.

## Job Execution
- **Job ID**: `job_851fb3e2-7636-43ef-8435-c425a6595fca`
- **Target**: `tgt_7a20e4fc-12f7-42c2-8e4d-4569053eeff6` (LINE app, PID 13791)
- **Type**: oneshot
- **Status**: Completed successfully

## Event Results

### 8.1 stdlib.stack - Stack Trace Utilities

#### stack.capture - getJavaStackTrace()
```json
{
  "event_id": "9659030b-bfb8-4c82-b334-bd1b66ffb171",
  "kind": "stack.capture",
  "payload": {
    "frame_count": 2,
    "first": {
      "className": "dalvik.system.VMStack",
      "methodName": "getThreadStackTrace",
      "fileName": "VMStack.java",
      "lineNumber": -2,
      "isNative": true
    }
  }
}
```

**Analysis**: Stack capture returns structured frame array with metadata including className, methodName, fileName, lineNumber, and native flag. The -2 lineNumber indicates native code.

#### stack.toString - getJavaStackTraceString()
```json
{
  "event_id": "d6597e48-e7af-41e2-a680-2193fe3f97ae",
  "kind": "stack.toString",
  "payload": {
    "stack": "at dalvik.system.VMStack.getThreadStackTrace(Native Method)\nat java.lang.Thread.getStackTrace(Thread.java:2842)"
  }
}
```

**Analysis**: Stack toString returns formatted string representation suitable for logging, showing native methods and source locations.

### 8.2 stdlib.inspect - Object Inspection Utilities

The job found 3 active Activity instances and inspected each:

#### Activity 1: InputPassActivity
```json
{
  "className": "com.linecorp.line.passlock.InputPassActivity",
  "simpleClassName": "InputPassActivity",
  "superclassChain": [
    "jp.naver.line.android.common.CommonBaseAppCompatActivity",
    "j.c",
    "androidx.fragment.app.y",
    "androidx.activity.ComponentActivity",
    "androidx.core.app.e",
    "android.app.Activity",
    "android.view.ContextThemeWrapper",
    "android.content.ContextWrapper",
    "android.content.Context",
    "java.lang.Object"
  ],
  "isActivity": true
}
```

**Analysis**: Full qualified name extraction, simple name parsing, complete inheritance chain traversal (showing obfuscated intermediate classes like `j.c` and `androidx.fragment.app.y`), and instance type checking all working correctly.

#### Activity 2: MainActivity
```json
{
  "className": "jp.naver.line.android.activity.main.MainActivity",
  "simpleClassName": "MainActivity",
  "superclassChain": [
    "rw6.b",
    "jp.naver.line.android.common.CommonBaseAppCompatActivity",
    "j.c",
    "androidx.fragment.app.y",
    "androidx.activity.ComponentActivity",
    "androidx.core.app.e",
    "android.app.Activity",
    "android.view.ContextThemeWrapper",
    "android.content.ContextWrapper",
    "android.content.Context",
    "java.lang.Object"
  ],
  "isActivity": true
}
```

**Analysis**: MainActivity has different immediate parent (`rw6.b`) showing obfuscation, but same base hierarchy.

#### Activity 3: SplashActivity
```json
{
  "className": "jp.naver.line.android.activity.SplashActivity",
  "simpleClassName": "SplashActivity",
  "superclassChain": [
    "jp.naver.line.android.common.CommonBaseAppCompatActivity",
    "j.c",
    "androidx.fragment.app.y",
    "androidx.activity.ComponentActivity",
    "androidx.core.app.e",
    "android.app.Activity",
    "android.view.ContextThemeWrapper",
    "android.content.ContextWrapper",
    "android.content.Context",
    "java.lang.Object"
  ],
  "isActivity": true
}
```

**Analysis**: SplashActivity shares same hierarchy as InputPassActivity, confirming consistent inspection across instances.

### 8.3 stdlib.classes - Class Discovery and Loading

#### classes.find() - Prefix Search
```json
{
  "event_id": "884ca5a6-26d6-40db-ad42-3f61a09be412",
  "kind": "classes.find.prefix",
  "payload": {
    "count": 10,
    "sample": [
      "jp.naver.line.android.activity.homev2.presenter.HomeListViewController$Companion",
      "jp.naver.line.android.chathistory.NormalMessageReactionDataSearcher$Companion",
      "jp.naver.line.android.talkop.fetch.StreamingFetchOperationHandler$a"
    ]
  }
}
```

**Analysis**: Prefix search found 10 classes starting with "jp.naver.line" (limited by {limit: 10}). Sample shows Kotlin companion objects and obfuscated inner classes.

**Note**: The find operation took approximately 1.3 seconds (from 06:20:18.355Z to 06:20:19.667Z), indicating it enumerates loaded classes which can be expensive.

#### classes.isLoaded() - Check Class Presence
```json
{
  "event_id": "fb3ec8f7-f7fe-46aa-b6e8-d95073e84cf3",
  "kind": "classes.isLoaded",
  "payload": {
    "cipher": true
  }
}
```

**Analysis**: `javax.crypto.Cipher` is loaded, confirming crypto usage in LINE app. This operation took ~1 second after the find operation.

#### classes.load() - Load Class Wrapper
```json
{
  "event_id": "e248a50a-6ba0-4868-b760-49bf5325b8ea",
  "kind": "classes.load",
  "payload": {
    "success": true
  }
}
```

**Analysis**: Successfully loaded Cipher class wrapper. The check shows `Cipher !== null`, confirming the wrapper object was returned.

#### safe.tryUse() - Safe Class Loading
```json
{
  "event_id": "ea548235-1e23-4792-867d-a9400459d279",
  "kind": "safe.tryUse.missing",
  "payload": {
    "found": false
  }
}
```

**Analysis**: Attempting to load non-existent class `com.fake.DoesNotExist` correctly returned null instead of throwing exception, confirming safe loading behavior.

## Validation Checklist

### 8.1 stdlib.stack
- [x] **stack.capture returns frame array**: Confirmed - returns structured array with className, methodName, fileName, lineNumber, isNative
- [x] **stack.toString returns formatted string**: Confirmed - returns readable stack trace string with "at ..." format

### 8.2 stdlib.inspect
- [x] **inspect.className returns full qualified name**: Confirmed - returns complete package path (e.g., "com.linecorp.line.passlock.InputPassActivity")
- [x] **inspect.simpleClassName returns simple name**: Confirmed - returns just class name without package (e.g., "InputPassActivity")
- [x] **inspect.superclassChain returns inheritance array**: Confirmed - returns complete chain from immediate parent to java.lang.Object, including obfuscated classes
- [x] **inspect.isInstance validates type**: Confirmed - correctly identified all instances as Activity subclasses

### 8.3 stdlib.classes
- [x] **classes.find with prefix finds LINE classes**: Confirmed - found 10 classes with "jp.naver.line" prefix
- [x] **classes.isLoaded returns boolean**: Confirmed - returned true for javax.crypto.Cipher
- [x] **classes.load returns wrapper**: Confirmed - successfully loaded Cipher class (success: true)
- [x] **safe.tryUse returns null for missing class**: Confirmed - returned null (found: false) for non-existent class without throwing

## Key Observations

### Performance Characteristics
1. **Stack operations**: Fast (< 35ms total)
2. **Inspect operations**: Fast per-instance (< 5ms each)
3. **Class enumeration**: Expensive (~1.3s for prefix search with limit 10)
4. **Class loading**: Moderate (~1s for isLoaded/load operations)

### Practical Insights
1. **Obfuscation visibility**: inspect.superclassChain reveals obfuscated class names (e.g., `j.c`, `rw6.b`) that may not be obvious from simple inspection
2. **Kotlin artifacts**: classes.find shows Kotlin-specific patterns like `$Companion` inner classes
3. **Safe patterns**: safe.tryUse enables defensive class loading without try/catch boilerplate
4. **Stack depth**: Stack traces from within Java.perform show minimal frames (just VMStack/Thread infrastructure)

### Stdlib API Quality
All tested stdlib utilities work as documented:
- **stack**: Provides both structured and string-formatted stack traces
- **inspect**: Comprehensive object introspection including type checking and hierarchy traversal
- **classes**: Full class discovery and safe loading with proper error handling

## Status
**COMPLETE** - All stdlib.stack, stdlib.inspect, and stdlib.classes utilities validated successfully with comprehensive event evidence.

## Recommendations
1. **Use classes.find sparingly**: The enumeration is expensive; cache results or use more specific queries
2. **Leverage superclassChain for obfuscated apps**: Critical for understanding class relationships in obfuscated code
3. **Prefer safe.tryUse for optional classes**: Cleaner code than try/catch blocks for optional class loading
4. **Stack traces for debugging**: The structured frame data is excellent for programmatic analysis of call paths
